<!DOCTYPE html>
{% load staticfiles %}
<html>
<head>
    <title>Foo</title>
</head>
<body>
<script>

    // overwrite the `languages` property to use a custom getter
    Object.defineProperty(navigator, 'languages', {
        get: function () {
            return ['en-US', 'en'];
        },
    });

    // overwrite the `plugins` property to use a custom getter
    Object.defineProperty(navigator, 'plugins', {
        get: function () {
            // this just needs to have `length > 0`, but we could mock the plugins too
            return [1, 2, 3, 4, 5];
        },
    });
    console.log("properties changes");

    const getParameter = WebGLRenderingContext.getParameter;
    WebGLRenderingContext.prototype.getParameter = function (parameter) {
        // UNMASKED_VENDOR_WEBGL
        if (parameter === 37445) {
            return 'Intel Open Source Technology Center';
        }
        // UNMASKED_RENDERER_WEBGL
        if (parameter === 37446) {
            return 'Mesa DRI Intel(R) Ivybridge Mobile ';
        }

        return getParameter(parameter);
    };
    console.log("rendering changed");

    ['height', 'width'].forEach(property => {
        // store the existing descriptor
        const imageDescriptor = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, property);

    // redefine the property with a patched descriptor
    Object.defineProperty(HTMLImageElement.prototype, property, {
        ...imageDescriptor,
        get: function () {
            // return an arbitrary non-zero dimension if the image failed to load
            if (this.complete && this.naturalHeight == 0) {
                return 20;
            }
            // otherwise, return the actual dimension
            return imageDescriptor.get.apply(this);
        },
    });
    });
    console.log("size changed");

    // store the existing descriptor
    const elementDescriptor = Object.getOwnPropertyDescriptor(HTMLElement.prototype, 'offsetHeight');

    // redefine the property with a patched descriptor
    Object.defineProperty(HTMLDivElement.prototype, 'offsetHeight', {
      ...elementDescriptor,
      get: function() {
        if (this.id === 'modernizr') {
            return 1;
        }
        return elementDescriptor.get.apply(this);
      },
    });
    console.log("modernizer changed")
</script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>
<button id="play" onclick="foo()">foo</button>
<input type="text" id="uri">


<script>
    var player;
    var player_state;
    var ready = false;

    // Spotify
    window.onSpotifyWebPlaybackSDKReady = () =>
    {

        var urlParams = new URLSearchParams(window.location.hash.substr(1));
        var token = urlParams.get('access_token');

        player = new Spotify.Player({
            name: 'foo',
            getOAuthToken: cb => {cb(token);
    }
    })
        ;

        // Error handling
        player.addListener('initialization_error', ({message}) => {console.error(message);
    })
        ;
        player.addListener('authentication_error', ({message}) => {console.error(message);
    })
        ;
        player.addListener('account_error', ({message}) => {console.error(message);
    })
        ;
        player.addListener('playback_error', ({message}) => {console.error(message);
    })
        ;

        // Playback status updates
        player.addListener('player_state_changed', state => {
            player_state = state;
        console.log(state);
    })
        ;

        // Ready
        player.addListener('ready', ({device_id}) => {
            ready = true;
        console.log('Ready with Device ID', device_id);
    })
        ;

        // Not Ready
        player.addListener('not_ready', ({device_id}) => {
            ready = false;
        console.log('Device ID has gone offline', device_id);
    })
        ;

        // Connect to the player!
        player.connect();

    }
    ;
    const play = ({
        spotify_uri,
        playerInstance: {
            _options: {
                getOAuthToken,
                id
            }
        }
    }) =>
    {
        getOAuthToken(access_token => {
            fetch(`https://api.spotify.com/v1/me/player/play?device_id=${id}`, {
            method: 'PUT',
            body: JSON.stringify({uris: [spotify_uri]}),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${access_token}`
            },
        }
    );});};


    function foo() {
        console.log("foo");
        play({
            playerInstance: player,
            spotify_uri: document.getElementById("uri").value,
        });
    }


</script>
</body>
</html>
